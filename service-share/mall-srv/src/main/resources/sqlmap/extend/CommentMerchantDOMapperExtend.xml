<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.lawu.eshop.mall.srv.mapper.extend.CommentMerchantDOMapperExtend">
    <resultMap id="BaseResultMap" type="com.lawu.eshop.mall.srv.domain.extend.CommentMerchantDOView">

        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="content" property="content" jdbcType="VARCHAR"/>
        <result column="reply_content" property="replyContent" jdbcType="VARCHAR"/>
        <result column="grade" property="grade" jdbcType="TINYINT"/>
        <result column="member_id" property="memberId" jdbcType="BIGINT"/>
        <result column="merchant_id" property="merchantId" jdbcType="BIGINT"/>
        <result column="is_anonymous" property="isAnonymous" jdbcType="BIT"/>
        <result column="status" property="status" jdbcType="TINYINT"/>
        <result column="gmt_modified" property="gmtModified" jdbcType="TIMESTAMP"/>
        <result column="gmt_create" property="gmtCreate" jdbcType="TIMESTAMP"/>
        <result column="gmt_reply" property="gmtReply" jdbcType="TIMESTAMP"/>

    </resultMap>

    <select id="selectAvgGrade" resultType="java.lang.Float" parameterType="java.lang.Long">
        SELECT
	    AVG(grade)
      FROM
	  comment_merchant
	  WHERE merchant_id =#{merchantId}
    </select>

    <!-- 根据商家ID查询用户评论总数(有图片)-->
    <select id="selectCountByMerchantId" resultType="java.lang.Integer" parameterType="java.lang.Long">
         SELECT
        COUNT(DISTINCT cm.id)
        FROM
        comment_merchant cm
        LEFT JOIN comment_image ci ON cm.id = ci.comment_id
        WHERE
        cm.merchant_id = #{merchantId}
         AND ci.type =1
        AND ci.img_url IS NOT NULL
    </select>

    <!-- 根据商家ID查询用户评论列表(有图片)-->
    <select id="selectCommentsWithImg" resultMap="BaseResultMap" parameterType="com.lawu.eshop.mall.param.CommentMerchantPageParam">
        SELECT
        DISTINCT cm.id as id,
        cm.content,
        cm.reply_content,
        cm.grade,
        cm.member_id,
        cm.is_anonymous,
        cm.status,
        cm.gmt_create,
        cm.merchant_id
        FROM
        comment_merchant cm
        LEFT JOIN comment_image ci ON cm.id = ci.comment_id
        WHERE
        cm.merchant_id = #{merchantId}
        AND ci.type =1
        AND ci.img_url IS NOT NULL
        ORDER  BY
        cm.id DESC
        LIMIT #{currentPage},#{pageSize}
    </select>

</mapper>